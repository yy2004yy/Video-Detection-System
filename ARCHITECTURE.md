# 项目架构与设计思路

## 🚀 主程序入口点

项目有三个主程序入口，分别对应不同的使用场景：

### 1. **train.py** - 训练入口
```bash
python train.py --config configs/clip_baseline.yaml
```

**执行流程：**
```
main() 函数启动
  ↓
1. 解析命令行参数（配置文件路径、是否恢复训练）
  ↓
2. 加载YAML配置文件
  ↓
3. 初始化日志系统
  ↓
4. 设置随机种子（保证可复现）
  ↓
5. 设置GPU设备
  ↓
6. 创建DeepFakeDetector模型
  ↓
7. 创建数据加载器（需要配置数据集路径）
  ↓
8. 定义损失函数和优化器
  ↓
9. 训练循环（train_epoch + validate）
  ↓
10. 保存检查点和最佳模型
```

### 2. **test.py** - 测试/评估入口
```bash
python test.py --config configs/clip_baseline.yaml --checkpoint checkpoints/best_model.pth
```

**执行流程：**
```
main() 函数启动
  ↓
1. 加载配置和检查点路径
  ↓
2. 创建模型并加载权重
  ↓
3. 创建测试数据集
  ↓
4. 在测试集上推理（test函数）
  ↓
5. 计算评估指标（准确率、F1、AUC等）
  ↓
6. 保存结果到文件
```

### 3. **inference.py** - 单视频推理入口
```bash
python inference.py --config configs/clip_baseline.yaml --checkpoint checkpoints/best_model.pth --video path/to/video.mp4
```

**执行流程：**
```
main() 函数启动
  ↓
1. 检查视频文件是否存在
  ↓
2. 加载配置和模型权重
  ↓
3. 调用inference_single_video()函数
    - 提取视频帧
    - 预处理图像
    - 模型推理
    - 返回预测结果和置信度
  ↓
4. 打印检测结果
```

---

## 📐 项目架构设计

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    主程序层 (Entry Points)              │
│  train.py  │  test.py  │  inference.py                 │
└────────────┬───────────┬───────────────────────────────┘
             │           │
             ▼           ▼
┌─────────────────────────────────────────────────────────┐
│                    配置管理层 (Config)                   │
│  configs/clip_baseline.yaml                            │
│  configs/imagebind_fusion.yaml                         │
└────────────┬────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────┐
│                    模型层 (Models)                       │
│  ┌──────────────────────────────────────────────┐      │
│  │  detectors.py (DeepFakeDetector)             │      │
│  │    ├── 分类头 (Classifier Head)              │      │
│  │    └── 骨干网络 (Backbone)                   │      │
│  └──────────────────────────────────────────────┘      │
│              │                    │                      │
│              ▼                    ▼                      │
│  ┌──────────────────┐  ┌──────────────────┐            │
│  │  CLIPEncoder     │  │ ImageBindEncoder │            │
│  │  (视觉特征提取)   │  │ (多模态特征提取)  │            │
│  └──────────────────┘  └──────────────────┘            │
└────────────┬────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────┐
│                    数据层 (Data)                        │
│  ┌──────────────────────────────────────────────┐      │
│  │  dataset.py (VideoDataset)                   │      │
│  │    ├── 视频帧提取                            │      │
│  │    └── 数据变换                              │      │
│  └──────────────────────────────────────────────┘      │
│              │                                          │
│              ▼                                          │
│  ┌──────────────────────────────────────────────┐      │
│  │  preprocess.py                               │      │
│  │    ├── extract_frames_from_video()           │      │
│  │    └── extract_audio_from_video()           │      │
│  └──────────────────────────────────────────────┘      │
└────────────┬────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────┐
│                    工具层 (Utils)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ logger.py│  │metrics.py│  │tools.py  │              │
│  │ 日志记录  │  │ 评估指标 │  │ 工具函数 │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 设计思路详解

### 1. **分层架构设计 (Layered Architecture)**

项目采用经典的分层架构，每一层职责明确：

- **主程序层**：用户交互入口，处理命令行参数
- **配置层**：统一管理所有超参数，便于实验管理
- **模型层**：核心算法实现，模块化设计
- **数据层**：数据加载和预处理，与模型解耦
- **工具层**：通用功能，可复用

**优势：**
- ✅ 代码解耦，易于维护
- ✅ 模块可独立测试
- ✅ 便于扩展新功能

### 2. **配置驱动设计 (Configuration-Driven)**

所有实验参数都通过YAML配置文件管理：

```yaml
# configs/clip_baseline.yaml
model:
  backbone: "clip"
  clip_model_name: "openai/clip-vit-base-patch32"
training:
  batch_size: 16
  learning_rate: 1e-4
```

**优势：**
- ✅ 无需修改代码即可调整参数
- ✅ 实验配置可版本控制
- ✅ 便于对比不同实验设置

### 3. **模块化模型设计 (Modular Model Design)**

模型采用"骨干网络 + 检测头"的设计：

```
DeepFakeDetector
  ├── Backbone (特征提取器)
  │   ├── CLIPEncoder (单模态：视觉)
  │   └── ImageBindEncoder (多模态：视觉+音频)
  └── Classifier (分类头)
      └── 多层全连接网络
```

**优势：**
- ✅ 可以轻松切换不同的backbone
- ✅ 便于迁移学习
- ✅ 支持多模态融合

### 4. **数据管道设计 (Data Pipeline)**

数据处理流程清晰：

```
原始视频
  ↓
preprocess.py: extract_frames_from_video()
  ↓
提取的帧 (PIL Images)
  ↓
dataset.py: VideoDataset.__getitem__()
  ↓
数据变换 (Resize, Normalize)
  ↓
Tensor格式 [batch, frames, C, H, W]
  ↓
模型输入
```

**优势：**
- ✅ 预处理与训练分离
- ✅ 支持数据增强
- ✅ 易于调试数据问题

### 5. **工具函数封装 (Utility Functions)**

通用功能统一封装：

- **logger.py**: 统一的日志系统，自动保存到文件
- **metrics.py**: 标准化的评估指标计算
- **tools.py**: 可复用的工具函数（随机种子、模型保存等）

**优势：**
- ✅ 代码复用
- ✅ 统一接口
- ✅ 便于维护

---

## 🔄 完整工作流程

### 训练流程

```
1. 准备数据
   └── 组织视频文件和标签

2. 配置实验
   └── 编辑 configs/*.yaml

3. 启动训练
   └── python train.py --config configs/clip_baseline.yaml

4. 监控训练
   └── 查看 logs/*.log

5. 保存模型
   └── checkpoints/best_model.pth
```

### 测试流程

```
1. 准备测试集
   └── 组织测试视频和标签

2. 运行测试
   └── python test.py --config ... --checkpoint ...

3. 查看结果
   └── test_results.txt (包含所有指标)
```

### 推理流程

```
1. 准备模型
   └── 确保有训练好的checkpoint

2. 运行推理
   └── python inference.py --checkpoint ... --video ...

3. 查看结果
   └── 控制台输出预测结果和置信度
```

---

## 💡 设计模式应用

### 1. **工厂模式 (Factory Pattern)**
- `DeepFakeDetector` 根据配置自动创建不同的backbone

### 2. **策略模式 (Strategy Pattern)**
- 不同的backbone（CLIP vs ImageBind）可以互换

### 3. **模板方法模式 (Template Method)**
- `train.py` 定义了训练流程模板，具体步骤可扩展

---

## 🎨 代码组织原则

1. **单一职责原则**：每个模块只做一件事
2. **开闭原则**：对扩展开放，对修改封闭
3. **依赖倒置**：高层模块不依赖低层模块，都依赖抽象
4. **接口隔离**：使用清晰的模块接口

---

## 📊 数据流向

```
配置文件 (YAML)
  ↓
主程序解析配置
  ↓
创建模型实例
  ↓
加载/创建数据集
  ↓
训练循环
  ├── 数据批次 → 模型 → 损失计算
  ├── 反向传播 → 参数更新
  └── 验证评估 → 指标计算
  ↓
保存检查点
  ↓
最佳模型 → 测试/推理
```

---

## 🔧 扩展指南

### 添加新的Backbone

1. 在 `models/backbones/` 创建新文件
2. 实现编码器类（继承 `nn.Module`）
3. 在 `models/backbones/__init__.py` 中导出
4. 在 `detectors.py` 中添加支持

### 添加新的评估指标

1. 在 `utils/metrics.py` 中添加计算函数
2. 在 `test.py` 中调用新指标

### 添加新的数据增强

1. 在 `data/dataset.py` 的 `transform` 中添加
2. 或创建新的预处理函数

---

## 📝 总结

这个项目架构的核心思想是：

1. **模块化**：每个功能独立成模块
2. **可配置**：通过配置文件控制行为
3. **可扩展**：易于添加新功能
4. **可维护**：清晰的代码组织
5. **可复现**：统一的随机种子和日志

这样的设计使得项目既适合研究实验，也适合生产部署。

